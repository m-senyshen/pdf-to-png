<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Map Extract</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* HERO SECTION */
        .hero {
            background: #f0f7ff;
            padding: 80px 20px;
            text-align: center;
        }

        .hero h1 {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .hero p {
            font-size: 20px;
            max-width: 600px;
            margin: 0 auto 30px;
            line-height: 1.5;
        }

        .cta-btn {
            padding: 14px 28px;
            background: #0077ff;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .cta-btn:hover {
            background: #005fcc;
        }

        /* UPLOAD BOX */
        .upload-box {
            border: 2px dashed #0077ff;
            border-radius: 12px;
            padding: 50px;
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            background: #f9fbff;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .upload-box:hover {
            background: #f0f7ff;
            border-color: #005fcc;
        }

        .upload-box p {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #0077ff;
        }

        .upload-box button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 6px;
            border: none;
            background: #0077ff;
            color: white;
            cursor: pointer;
        }

        .upload-box button:hover {
            background: #005fcc;
        }

        /* PDF canvas */
        #pdf-canvas {
            border: 1px solid #ccc;
            display: block;
            margin: 20px auto;
            max-width: 90%;
            max-height: 600px;
        }

        /* HOW IT WORKS SECTION */
        .how-it-works {
            padding: 60px 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .how-it-works h2 {
            font-size: 36px;
            margin-bottom: 50px;
            text-align: center;
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            justify-items: center;
        }

        .step {
            background: #fafafa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #eee;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .step h3 {
            margin-bottom: 10px;
        }

        /* Spinner */
        #spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
    </style>
</head>

<body>

  <!-- HERO SECTION -->
  <section class="hero">
    <h1>Map Extract</h1>
    <p>Upload any map PDF and extract water areas as a starting point for GIS workflows.</p>

    <div class="upload-box" id="upload-box">
        <p>Drag & drop PDF here</p>
        <button id="select-file-btn">Select Your File</button>
        <input type="file" id="pdf-upload" accept=".pdf" style="display:none" />
    </div>

    <img id="spinner" src="./assets/spinner.gif" alt="Processing..." />

    <canvas id="pdf-canvas"></canvas>
  </section>

  <!-- HOW IT WORKS -->
  <section class="how-it-works">
    <h2>How It Works</h2>

    <div class="steps">
      <div class="step">
        <h3>1. Upload Your Map</h3>
        <p>Select or drag and drop a PDF map.</p>
      </div>

      <div class="step">
        <h3>2. Segment Water</h3>
        <p>Draw a rectangle on the map to extract water areas.</p>
      </div>

      <div class="step">
        <h3>3. Download</h3>
        <p>Receive the extracted PNG or shapefile for GIS analysis.</p>
      </div>
    </div>
  </section>

  <!-- PDF.js libraries -->
  <script src="./libs/pdf.js"></script>
  <script src="./libs/pdf.worker.js"></script>

  <!-- SAM script -->
  <script type="module">
    import { samSegment } from './libs/sam.js';

    const fileInput = document.getElementById('pdf-upload');
    const selectBtn = document.getElementById('select-file-btn');
    const uploadBox = document.getElementById('upload-box');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const spinner = document.getElementById('spinner');

    selectBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', handleFile);

    async function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        spinner.style.display = 'block';

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({scale: 2});
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({canvasContext: ctx, viewport}).promise;
        } catch(err) {
            alert('Error loading PDF');
            console.error(err);
        } finally {
            spinner.style.display = 'none';
        }
    }

    // Rectangle selection for segmentation
    let rectStart = null;
    let rectEnd = null;

    canvas.addEventListener('mousedown', e => {
        const rect = canvas.getBoundingClientRect();
        rectStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    });

    canvas.addEventListener('mouseup', async e => {
        if (!rectStart) return;
        const rect = canvas.getBoundingClientRect();
        rectEnd = { x: e.clientX - rect.left, y: e.clientY - rect.top };

        const x = Math.min(rectStart.x, rectEnd.x);
        const y = Math.min(rectStart.y, rectEnd.y);
        const width = Math.abs(rectEnd.x - rectStart.x);
        const height = Math.abs(rectEnd.y - rectStart.y);

        try {
            spinner.style.display = 'block';
            const imageData = ctx.getImageData(x, y, width, height);
            const mask = await samSegment(imageData); // SAM-assisted segmentation
            ctx.putImageData(mask, x, y);
        } catch(err) {
            alert('Segmentation failed');
            console.error(err);
        } finally {
            spinner.style.display = 'none';
        }

        rectStart = null;
        rectEnd = null;
    });

  </script>

</body>
</html>
