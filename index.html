<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Map Extract — PDF → PNG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f9fc;color:#222;margin:0}
    .container{max-width:900px;margin:48px auto;padding:20px;text-align:center}
    h1{margin:0 0 12px;font-size:32px}
    .upload-box{border:3px dashed #0077ff;background:#f0f7ff;padding:40px;border-radius:10px;cursor:pointer;transition:.15s}
    .upload-box.dragover{background:#e6f0ff}
    #selectBtn{margin-top:14px;padding:10px 18px;border:none;background:#0077ff;color:#fff;border-radius:6px;cursor:pointer}
    #selectBtn:disabled{opacity:.5;cursor:not-allowed}
    #spinner{display:none;margin-top:18px;color:#0077ff}
    #pageList{margin-top:28px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .thumb{background:#fff;border:1px solid #ddd;padding:6px;border-radius:6px;cursor:pointer;transition:.12s}
    .thumb:hover{box-shadow:0 6px 18px rgba(0,0,0,0.08);border-color:#0077ff}
    #downloadLink{display:none;margin-top:20px;padding:10px 18px;background:#28a745;color:#fff;border-radius:6px;text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Map Extract — PDF → PNG</h1>

    <div id="uploadBox" class="upload-box" role="button" aria-label="Upload PDF">
      <p><strong>Drag & drop a PDF here</strong></p>
      <button id="selectBtn" type="button">Select Your File</button>
      <input id="fileInput" type="file" accept="application/pdf" style="display:none">
    </div>

    <div id="spinner">Processing…</div>

    <div id="pageList" aria-live="polite"></div>

    <a id="downloadLink" href="#" download>Download PNG</a>
  </div>

  <!-- Load PDF.js as ES module (local files in ./libs) -->
  <script type="module">
  (async () => {
    // small runtime guard so errors produce console info
    try {
      // dynamic import of the local ES module build of PDF.js
      const pdfjs = await import('./libs/pdf.mjs');
      // set worker path (relative)
      pdfjs.GlobalWorkerOptions.workerSrc = './libs/pdf.worker.mjs';
      console.log('pdf.mjs loaded (version:', pdfjs.version || 'unknown', ')');

      // Wait for DOM ready before hooking UI
      window.addEventListener('DOMContentLoaded', () => {
        // Element references
        const uploadBox = document.getElementById('uploadBox');
        const selectBtn = document.getElementById('selectBtn');
        const fileInput = document.getElementById('fileInput');
        const spinner = document.getElementById('spinner');
        const pageList = document.getElementById('pageList');
        const downloadLink = document.getElementById('downloadLink');

        if (!uploadBox || !selectBtn || !fileInput) {
          console.error('Critical DOM elements missing; aborting initialization.');
          return;
        }

        console.log('DOM ready — attaching handlers');

        function showSpinner(msg = 'Processing…') {
          spinner.textContent = msg;
          spinner.style.display = 'block';
          downloadLink.style.display = 'none';
          selectBtn.disabled = true;
          uploadBox.style.pointerEvents = 'none';
        }
        function hideSpinner() {
          spinner.style.display = 'none';
          selectBtn.disabled = false;
          uploadBox.style.pointerEvents = 'auto';
        }

        // Open file picker when button clicked
        selectBtn.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (ev) => {
          const f = ev.target.files && ev.target.files[0];
          if (f) handleFile(f);
        });

        // Drag & drop visuals and drop handling
        uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); uploadBox.classList.add('dragover'); });
        uploadBox.addEventListener('dragleave', (e) => { e.preventDefault(); uploadBox.classList.remove('dragover'); });
        uploadBox.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadBox.classList.remove('dragover');
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (f) handleFile(f);
        });

        // Convert a page to PNG and set download link
        async function renderPageToPng(pdfDoc, pageNum) {
          showSpinner('Rendering page…');
          try {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 2 });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;
            const pngUrl = canvas.toDataURL('image/png');
            downloadLink.href = pngUrl;
            downloadLink.download = `page-${pageNum}.png`;
            downloadLink.style.display = 'inline-block';
            console.log('Rendered page', pageNum);
          } catch (err) {
            console.error('renderPageToPng error', err);
            alert('Error rendering page — see console.');
          } finally {
            hideSpinner();
          }
        }

        // Create and show thumbnails for every page
        async function renderThumbnails(pdfDoc) {
          pageList.innerHTML = '';
          for (let i = 1; i <= pdfDoc.numPages; i++) {
            try {
              const page = await pdfDoc.getPage(i);
              const viewport = page.getViewport({ scale: 0.25 });
              const canvas = document.createElement('canvas');
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              const ctx = canvas.getContext('2d');
              await page.render({ canvasContext: ctx, viewport }).promise;

              const thumbWrap = document.createElement('div');
              thumbWrap.className = 'thumb';
              thumbWrap.appendChild(canvas);
              thumbWrap.title = `Page ${i}`;
              thumbWrap.addEventListener('click', () => renderPageToPng(pdfDoc, i));
              pageList.appendChild(thumbWrap);
            } catch (err) {
              console.warn('Thumbnail render failed for page', i, err);
            }
          }
        }

        // Main file handler
        async function handleFile(file) {
          if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
            alert('Please select a PDF file.');
            return;
          }
          console.log('File selected:', file.name);
          showSpinner('Loading PDF…');

          try {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await pdfjs.getDocument({ data: arrayBuffer }).promise;
            console.log('PDF loaded, pages:', pdfDoc.numPages);
            await renderThumbnails(pdfDoc);
            hideSpinner();
            // Optionally auto-render first page: comment out to require click
            // renderPageToPng(pdfDoc, 1);
          } catch (err) {
            console.error('Error processing PDF', err);
            alert('Error processing PDF (see console).');
            hideSpinner();
          }
        }

        // expose for debugging (optional)
        window.__mapExtract = { handleFile };
      }); // DOMContentLoaded
    } catch (err) {
      console.error('Error loading pdf module', err);
      alert('PDF library failed to load — check console and ensure ./libs/pdf.mjs and ./libs/pdf.worker.mjs exist and are served (200).');
    }
  })();
  </script>
</body>
</html>
