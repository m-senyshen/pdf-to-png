<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Map Extract</title>
    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:0; color:#333; }
        .hero { background:#f0f7ff; padding:40px 20px; text-align:center; }
        .hero h1 { font-size:48px; margin-bottom:20px; }
        .hero p { font-size:20px; max-width:600px; margin:0 auto 30px; line-height:1.5; }
        .upload-box { border:2px dashed #0077ff; border-radius:12px; padding:50px; max-width:400px; margin:20px auto; text-align:center; background:#f9fbff; cursor:pointer; }
        .upload-box:hover { background:#f0f7ff; border-color:#005fcc; }
        .upload-box p { margin:0 0 15px 0; font-size:18px; color:#0077ff; }
        .upload-box button { padding:10px 20px; font-size:16px; border-radius:6px; border:none; background:#0077ff; color:white; cursor:pointer; }
        .upload-box button:hover { background:#005fcc; }
        canvas { display:block; margin:20px auto; border:1px solid #ccc; cursor: crosshair; }
    </style>
</head>
<body>

<section class="hero">
    <h1>Map Extract</h1>
    <p>Upload a map PDF and segment areas of interest.</p>

    <div class="upload-box" id="upload-box">
        <p>Drag & drop PDF here</p>
        <button id="select-pdf">Select Your File</button>
        <input type="file" id="pdf-upload" accept="application/pdf" style="display:none" />
    </div>

    <canvas id="map-canvas"></canvas>
</section>

<!-- PDF.js local libs -->
<script src="./libs/pdf.js"></script>
<script src="./libs/pdf.worker.js"></script>

<!-- SAM script -->
<script src="./libs/sam.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('pdf-upload');
    const selectBtn = document.getElementById('select-pdf');
    const canvas = document.getElementById('map-canvas');
    const ctx = canvas.getContext('2d');

    selectBtn.addEventListener('click', () => fileInput.click());

    let pdfViewport;

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        const page = await pdf.getPage(1);
        pdfViewport = page.getViewport({scale: 2});
        canvas.width = pdfViewport.width;
        canvas.height = pdfViewport.height;

        await page.render({canvasContext: ctx, viewport: pdfViewport}).promise;
    });

    // DRAGGABLE RECTANGLE
    let rect = null;
    let isDragging = false;
    let startX = 0, startY = 0;

    canvas.addEventListener('mousedown', (e) => {
        const rectCanvas = canvas.getBoundingClientRect();
        startX = e.clientX - rectCanvas.left;
        startY = e.clientY - rectCanvas.top;
        rect = { x: startX, y: startY, width: 0, height: 0 };
        isDragging = true;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rectCanvas = canvas.getBoundingClientRect();
        const currentX = e.clientX - rectCanvas.left;
        const currentY = e.clientY - rectCanvas.top;
        rect.width = currentX - startX;
        rect.height = currentY - startY;

        // Redraw PDF page
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pdfjsLib.getDocument({data:fileInput.files[0].arrayBuffer()}).promise.then(pdf => {
            pdf.getPage(1).then(page => {
                const viewport = pdfViewport;
                page.render({canvasContext: ctx, viewport: viewport}).promise.then(() => {
                    // Draw rectangle
                    if(rect){
                        ctx.strokeStyle = 'red';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
                        ctx.fillStyle = 'rgba(255,0,0,0.2)';
                        ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    }
                });
            });
        });
    });

    canvas.addEventListener('mouseup', async () => {
        if (!isDragging) return;
        isDragging = false;
        if(rect && window.samSegment){
            const mask = await window.samSegment(canvas, rect);
            console.log('Segmentation mask:', mask);
        }
    });
});
</script>
</body>
</html>
